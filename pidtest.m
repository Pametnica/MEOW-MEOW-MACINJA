function J = pidtest(G, dt, parms,Reference)
s = tf('s');
K = parms(1) + parms(2)/s + parms(3)*s/(1 + 0.001*s);

Loop = series(K, G);
ClosedLoop = feedback(Loop, 1);

t_final = 10; % Vkupno vreme na simulacija
t = 0:dt:t_final;
%Reference = 0.7;

%CTRLtf = K/(1 + K*G);

% ???? ?? ???????????? y
%[y,t] = step(ClosedLoop,t);
[y_unscaled, t] = step(ClosedLoop, t); 
y = y_unscaled * Reference;

% ???? ????? ?? ?? ???????? y
%u = lsim(K, 1 - y, t);
E = Reference - y; 
u = lsim(K, E, t); % u = K * E
%Q = 1;
%R = 0.01;
alpha = 0.001;  % ?????? ?? U^2 (????????? ?? ????????? ????????? ??????)
beta = 0.005;   % ?????? ?? |E| (????????? ???? ???????? ?? ????????)
omega_tr = 0.5; % ?????? ?? ??????? ?? ?????? (tr)
omega_os = 10;  % ?????? ?? ????????? (OS) - ?????? ?? ?? ?? ?????? ?????????
omega_ss = 2;   % ?????? ?? ??????? ?? ????????? (tss)

% ?????? 1: ???? E^2 (Sqaured Error)
Sum_E_squared = dt * sum(E.^2);

    % ?????? 2: ???? U^2 (Sqaured Control Effort)
Sum_U_squared = dt * sum(u.^2);

    % ?????? 3: ???? |E| (Absolute Error)
Sum_abs_E = dt * sum(abs(E));
info = stepinfo(y, t, Reference);
tr = info.RiseTime;
OS_percentage = info.Overshoot;
    if isempty(OS_percentage) || isnan(OS_percentage)
        OS_percentage = 0; 
    end
 OS_abs = (OS_percentage / 100.0) * Reference; 

    tss = info.SettlingTime;
    
%J = dt * sum( Q*(1 - y(:)).^2 + R*(u(:)).^2 );
J = Sum_E_squared + ...
        alpha * Sum_U_squared + ...
        beta * Sum_abs_E + ...
        omega_tr * tr + ...
        omega_os * OS_abs + ...
        omega_ss * tss;

    % 7. ??????
plot(t, y, 'linewidth', 2, 'color', 'r')
hold on;
plot(t, Reference*ones(size(t)), 'w--'); % ?????????? ??????
hold off;
title(sprintf('R=%.2f, J = %.4f', Reference, J), 'Color', 'w');
xlabel('????? (s)', 'Color', 'w');
ylabel('????? (y)', 'Color', 'w');
grid on;
set(gca, 'color', 'k', 'xcolor', 'w', 'ycolor', 'w')
set(gcf, 'color', 'k')
drawnow
end

