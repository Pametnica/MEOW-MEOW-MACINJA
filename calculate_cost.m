function J = calculate_cost(G, dt, parms, Reference)
% ?? ?????????? ????????? ?? ?????????? ?? ???? (J) ?? ?????? PID ?????????,
% ?????????? ?? ?????? ?????????? ?????????? ???? ? pidtest.m.
% (??? ??????).

    s = tf('s');
    Kp = parms(1); 
    Ki = parms(2); 
    Kd = parms(3);
    
    % PID ????????? ?? ?????? ?? ????????????? ???
    tau_d = 0.001;
    K = Kp + Ki/s + Kd*s/(1 + tau_d*s); 

    Loop = series(K, G);
    ClosedLoop = feedback(Loop, 1);

    [y_unscaled, t] = step(ClosedLoop, t); 
    y = y_unscaled * Reference;
    % ... ????????? ?? y ...
    
    E = Reference - y; % ??????
    
    % ?????? ???????? ?? lsim:
    % lsim ???? U ?? ???? ?????? ?????? (N x 1) ??? ???????.
    
    % ??????? ?? ???? E ? ?????? ?????? ??? ?? ? ????:
    if size(E, 2) > 1
        E = E'; % ??? ? ??? ??????, ???????????? ??
    end
    
    u = lsim(K, E, t); % ???? ?????? ???? ????? ?? ??????.
    % ????? ? ??????
    [y_unscaled, ~] = step(ClosedLoop, t); 
    y = y_unscaled * Reference; % ????????? ?????? Reference
    
   % E = Reference - y; % ??????
    %u = lsim(K, E, t); % ????????? ?????? (?????)
    
    % =================================================================
    % ???????? ??????? (???? ?? ?? ???? ???? ?? pidtest.m)
    alpha = 0.001;  
    beta = 0.005;   
    omega_tr = 0.5; 
    omega_os = 10;  
    omega_ss = 2;   
    % =================================================================

    % 1. ???????????? ?? ????????? ?? ?????? (?????????)
    Sum_E_squared = dt * sum(E.^2);
    Sum_U_squared = dt * sum(u.^2);
    Sum_abs_E = dt * sum(abs(E));

    % 2. ???????????? ?? ????????? ?? ???????
    info = stepinfo(y, t, Reference);
    tr = info.RiseTime;
    
    OS_percentage = info.Overshoot;
    if isempty(OS_percentage) || isnan(OS_percentage)
        OS_percentage = 0; 
    end
    OS_abs = (OS_percentage / 100.0) * Reference; 
    tss = info.SettlingTime;

    % 3. ??????? ???????? ?? ???? (J)
    % COST = SUM(E^2) + alpha*SUM(U^2) + beta*SUM(|E|) + omega_tr*tr + omega_os*OS + omega_ss*tss
    J = Sum_E_squared + ...
        alpha * Sum_U_squared + ...
        beta * Sum_abs_E + ...
        omega_tr * tr + ...
        omega_os * OS_abs + ...
        omega_ss * tss;
end